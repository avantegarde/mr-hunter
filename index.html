<!DOCTYPE html>
<html>
<head>
    <meta charset=utf-8>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, minimal-ui" />
    <title>Mr. Hunter</title>
    <link rel="stylesheet" href="game-icons.min.css" type="text/css" media="all" />
    <link rel="stylesheet" href="style.css" type="text/css" media="all" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
</head>
<body>
<div id="game" class="clearfix">
    <div id="notif"></div>
    <!-- Header -->
    <div id="header" class="clearfix">
        <span class="toggle-inventory"><i class="gi gi-backpack"></i></span>
        <span id="level">Lvl: <span></span></span>
        <span id="xp">XP: <span></span></span>
        <!-- <span id="units">units: 0</span> -->
        <span id="game-reset">üóëÔ∏è</span>
    </div>
    <!-- Battleground -->
    <div id="battleground" class="clearfix"></div>
    <!-- Inventory -->
    <div id="inventory" class="clearfix"></div>
    <!-- Character -->
    <div id="character" class="clearfix"></div>
</div><!-- #game -->

<!-- Start JS -->
<script>
$(document).ready(function() {
    /**
     * Random number between 2 integers
     * @param int, int
     */
    function randomIntFromInterval(min,max) {
        return Math.floor(Math.random()*(max-min+1)+min);
    }
    /**
     * Random Elemental Choice
     */
    function randomElemental() {
        var elements = [
            'water',
            'fire',
            'earth'
        ];
        var element = elements[Math.floor(Math.random() * elements.length)];
        return element;
    }
    /**
     * Random Monster Name
     */
    function randomMonsterName() {
        var adjectives = ["little", "sea", "huge", "strange", "double", "prehistoric", "human", "marine", "hideous", "fabulous", "mythical", "terrible", "horrible", "moral", "headed", "eyed", "grotesque", "evil", "inhuman", "hopeful", "ugly", "winged", "fantastic", "giant", "mechanical", "imaginary", "like", "female", "savage", "frightful", "big", "mythological", "gigantic", "cruel", "antediluvian", "extinct", "ferocious", "eating", "green", "horrid", "supernatural", "fierce", "hairy", "maligned", "dangerous", "famous", "unnatural", "scary", "uncouth", "shapeless", "dreadful", "fearful", "headless", "cold", "baggy", "alien", "mighty", "bloodthirsty", "aquatic", "fearsome", "legendary", "unknown", "primeval", "sacred", "scaly", "hungry", "enormous", "loose", "unwieldy", "grim", "voracious", "fabled", "weird", "hybrid", "dead"];
        var nouns = ["ninja", "raven", "demon", "statue", "unicorn", "rainbows", "laser", "bunny", "captain", "nibblets", "cupcake", "carrot", "gnomes", "glitter", "potato", "salad", "toejam", "curtains", "beets", "toilet", "exorcism", "stick figures", "mermaid eggs", "sea barnacles", "dragons", "jellybeans", "snakes", "dolls", "bushes", "cookies", "apples", "ice cream", "ukulele", "kazoo", "banjo", "opera singer", "circus", "trampoline", "carousel", "carnival", "locomotive", "balloon", "mantis", "animator", "artisan", "artist", "colorist", "inker", "coppersmith", "director", "designer", "flatter", "stylist", "leadman", "limner", "model", "musician", "penciller", "producer", "scenographer", "decorator", "silversmith", "teacher", "mechanic", "beader", "clerk", "attendant", "foreman", "engineer", "miller", "molder", "panel beater", "patternmaker", "plumber", "sawfiler", "foreman", "soaper", "wheelwright", "woodworkers"];
        return randomName(adjectives) + ' ' + randomName(nouns);
    }
    /**
     * Random Name Picker
     */
    function randomName(list) {
        var i = Math.floor(Math.random() * list.length);
        return list[i];
    }
    /**
     * Global Variables
     */
    var SAVE_KEY = 'game_save';
    var state = load();
    if (state && state.monsters && state.inventory) {
        state = state;
    } else {
        var state = {
            player: {
                lvl: 1,
                xp: 0,
                units: 10,
                health: 100,
                maxHealth: 100,
                weapon: {
                    id: '001',
                    name: 'sword',
                    dmg: 25,
                    el: 'water',
                    crit: 25 * 2,
                    special: 25 + (25 / 2),
                    imgURL: 'img/Sword1.png'
                }
            },
            inventory:[{
                id: '001',
                name: 'sword',
                dmg: 25,
                el: 'water',
                crit: 25 * 2,
                special: 25 + (25 / 2),
                imgURL: 'img/Sword1.png'
            }],
            level: 'stage1'
        };
        state.monsters = buildMonsters(state.player);
        save(state);
    }
    console.log(state);
    //var monsters = state.monsters;
    /**
     * Initial Load / Save
     */
    renderCharacter(state.player);
    renderMonsters(state.monsters);
    renderInventory(state.inventory);
    updatePlayer(state.player);
    /**
     * Save state
     * @param state
     */
    function save(state) {
        localStorage.setItem(SAVE_KEY, JSON.stringify(state));
    }
    /**
     * Load state
     */
    function load() {
        return JSON.parse(localStorage.getItem(SAVE_KEY));
    }
    /**
     * Game Reset
     */
    function gameReset() {
        var state = '';
        save(state);
        window.location.reload(true);
    }
    /**
     * Game Reset
     * usage: notif.ok('OK!');
     * usage: notif.err('Error!');
     */
    var notif = {
        ok: function(message){
            var holder = $('#notif');
            holder.removeClass();
            holder.addClass('ok');
            displayNotification(message);
        },
        err: function(message){
            var holder = $('#notif');
            holder.removeClass();
            holder.addClass('err');
            displayNotification(message);
        }
    };
    function displayNotification(message) {
        var holder = $('#notif');
        holder.empty();
        holder.append(message);
        holder.addClass('active');
        setTimeout(function(){
            holder.removeClass('active');
            setTimeout(function(){
                holder.empty();
            }, 3500);
        }, 3000);
    }
    /**
     * Coin Toss
     * returns true or false
     */
    function coinToss() {
        console.log(Math.random())
        return Math.random() > 0.5;
    }
    function rollDice(n){
        var number = n?n:1;
        var x = Math.floor(Math.random() * ((6-1)+1) + 1);
        var y = Math.floor(Math.random() * ((6-1)+1) + 1);
        if(number === 2) {
            var total = x + y;
        } else {
            total = x;
        }
        return total;
    }
    /**
     * Attack
     */
    function attack(player, monster){
        var playerHealth = player.health;
        var playerDMG = player.weapon.dmg;
        var playerCrit = player.weapon.crit;
        var weaponEl = player.weapon.el;
        var monsterHealth = monster.health;
        var monsterDMG = monster.dmg;
        var monsterEl = monster.el;
        var critRollPlayer = rollDice(2);
        var critRollMonster = rollDice(2);

        if(critRollPlayer === 7){
            criticalHitMonster(monster);
            monster.health = monsterHealth - playerCrit;
        } else {
            monster.health = monsterHealth - playerDMG;
        }
        if (monster.health < 1) {
            grantXP(player, 125);
            destroyMonster(monster);
            var monsterCount = $('#battleground').find('.monster').length;
            if(monsterCount <= 0) {
                levelComplete();
            }
        } else {
            updateMonster(monster);
            if(critRollMonster === 7){
                criticalHitPlayer();
                player.health = playerHealth - monster.crit;
            } else {
                player.health = playerHealth - monsterDMG;
            }
        }
        if (player.health < 1) {
            destroyPlayer(player);
        } else {
            updatePlayer(player);
        }
    }
    /**
     * Critical Hit Player
     */
    function criticalHitPlayer() {
        var healthbar = $('#character .healthbar');
        healthbar.addClass('animated headShake');
        healthbar.find('.inner-health').addClass('animated headShake');
        setTimeout(function(){
            healthbar.removeClass('animated headShake');
            healthbar.find('.inner-health').removeClass('animated headShake');
        }, 1000);
    }
    /**
     * Critical Hit Monster
     */
    function criticalHitMonster(monster) {
        var healthbar = $('.monster[data-monster="'+ monster.name +'"]').find('.healthbar');
        healthbar.addClass('animated headShake');
        healthbar.find('.inner-health').addClass('animated headShake');
        setTimeout(function(){
            healthbar.removeClass('animated headShake');
            healthbar.find('.inner-health').removeClass('animated headShake');
        }, 1000);
    }
    /**
     * Get Monster
     * @param monsterID
     */
    function getMonster(monsterID){
        for(i=0;i<state.monsters.length;i++){
            if(state.monsters[i].name === monsterID){
                return state.monsters[i];
            }
        }
    }
    /**
     * Update Monster
     * @param monster
     */
    function updateMonster(monster){
        console.log('updateMonster(monster)');
        // Update Healthbar
        var healthbar = $('.monster[data-monster="'+ monster.name +'"]').find('.healthbar');
        healthbar.find('.health-digit > span').html(monster.health);
        var newHealth = Math.floor( (monster.health / monster.maxHealth) * 100);
        healthbar.find('.inner-health').width(newHealth + '%');
    }
    /**
     * Destroy Monster
     * @param monster
     */
    function destroyMonster(monster){
        console.log('destroyMonster(monster)');
        $('.monster[data-monster="'+ monster.name +'"]').remove();
    }
    /**
     * Update Player
     * @param player
     */
    function updatePlayer(player){
        console.log('updatePlayer(player)');
        // Update Header Info
        var lvl = $('#header #level > span');
        var xp = $('#header #xp > span');
        lvl.html(player.lvl);
        xp.html(player.xp);
        // Update Healthbar
        var healthbar = $('#character .healthbar');
        healthbar.find('.health-digit > span').html(player.health);
        var newHealth = Math.floor( (player.health / player.maxHealth) * 100);
        healthbar.find('.inner-health').width(newHealth + '%');
    }
    /**
     * Grant XP
     * @param int
     */
    function grantXP(player, xp){
        console.log('grantXP(player, int)');
        player.xp = player.xp + xp;
        if (player.xp >= 1000) {
            var lvlInc = Math.floor(player.xp / 1000);
            player.lvl = player.lvl + lvlInc;
            player.xp = player.xp - (lvlInc * 1000);
        }
    }
    /**
     * Destroy Player
     * @param player
     */
    function destroyPlayer(player){
        console.log('destroyPlayer(player)');
        notif.err('You Died! üò¢');
        //gameReset();
        var player_lvl = (player.lvl>1)?(player.lvl-1):1;
        state.player.lvl = player_lvl;
        state.player.xp = 0;
        state.player.health = state.player.maxHealth;
        state.level = 'stage1';
        state.monsters = buildMonsters(state.player);
        renderMonsters(state.monsters);
        updatePlayer(state.player);
        save(state);
    }
    /**
     * Update Player Weapon
     * @param player
     */
    function updatePlayerWeapon(player){
        console.log('updatePlayerWeapon(player)');
        var weaponHolder = $('#character #weapon .weapon-holder');
        weaponHolder.empty();
        weaponHolder.html('<img src="'+ player.weapon.imgURL +'">');
        // Close Inventory
        var inventory = $('#inventory');
        if(inventory.hasClass('active')){
            inventory.removeClass('active');
        } else {
            inventory.addClass('active');
        }
        save(state);
    }
    /**
     * Delete Inventory Item
     * @param itemID
     */
    function deleteInventoryItem(itemID){
        console.log('deleteInventoryItem(inventory)');
        var inventory = state.inventory;
        for(i=0;i<inventory.length; i++){
            var itemIndex = inventory.indexOf(inventory[i]);
            if(inventory[i].id === itemID){
                if(state.player.weapon.id === itemID) {
                    notif.err('You cannot delete an equipped weapon.');
                } else {
                    inventory.splice(itemIndex, 1);
                }
            }
        }
        renderInventory(inventory);
        save(state);
    }
    /**
     * Level Complete
     * @param monsterID
     */
    function levelComplete(){
        notif.ok('Level Complete! You found a new weapon! Check your inventory.');
        state.monsters = buildMonsters(state.player);
        renderMonsters(state.monsters);
        state.player.maxHealth = state.player.maxHealth + 10;
        state.player.health = state.player.maxHealth;
        updatePlayer(state.player);
        //generate weapon
        var weapon = generateWeapon(state.player);
        if(state.inventory.length > 60) {
            notif.err('You have too many items. please remove some before completing the next level.');
        } else {
            state.inventory.push(weapon);
        }
        renderInventory(state.inventory);
        //save
        save(state);
    }
    /**
     * Render Character
     * @param player
     */
    function renderCharacter(player){
        console.log('renderCharacter()');
        var character = $('#character');
        var frag = [];
        if(character) {
            character.empty();
            frag.push('' +
                '<div class="character-left clearfix">' +
                '   <div id="player"><i class="gi gi-astronaut-helmet"></i></div>' +
                '   <div id="health">' +
                '       <div class="healthbar">' +
                '           <span class="health-digit"><span>100</span> ‚ù§Ô∏è</span>' +
                '           <div class="inner-health"></div>' +
                '       </div>' +
                '   </div>' +
                '</div>' +
                '<div class="character-right clearfix">' +
                '   <div id="potion" class="player-potion">' +
                '   <span class="inner">üçï</span>' +
                '</div>' +
                '<div id="weapon" class="player-attack">' +
                '   <span class="weapon-holder inner">' +
                '       <img src="'+ player.weapon.imgURL +'">' +
                '   </span>' +
                '</div>');
            character.append(frag.join(''));
        }
    }
    /**
     * Build Monsters
     * @param monsters
     */
    function buildMonsters(player){
        console.log('buildMonsters()');
        var monsters = [];
        var monster_number = randomIntFromInterval(3,10);
        var monster_lvl = player.lvl;
        for(i=0;i<monster_number;i++){
            var healthCalc = player.lvl * 100;
            var monster_health = randomIntFromInterval((healthCalc / 1.5),healthCalc);
            var monster_dmg = randomIntFromInterval(player.maxHealth / 6,player.maxHealth / 4.1);
            var monster_crit = randomIntFromInterval(monster_dmg * 1.25,monster_dmg * 1.75);
            var monster_armor = 10*Math.floor(Math.random()*11);
            var sprite_x = 64*Math.floor(Math.random()*16);
            var sprite_y = 64*Math.floor(Math.random()*16);
            var monster = {
                lvl: monster_lvl,
                el: randomElemental(),
                dmg: monster_dmg,
                crit: monster_crit,
                armor: monster_armor,
                health: monster_health,
                maxHealth: monster_health,
                name: randomMonsterName(),
                id: monster_number[i],
                imgX: sprite_x,
                imgY: sprite_y
            };
            monsters.push(monster);
        }
        //console.log(monsters)
        return monsters;
    }
    /**
     * Render the monsters in the battlefield
     * @param monsters
     */
    function renderMonsters(monsters){
        console.log('renderMonsters()');
        // Update Healthbar
        var battleground = $('#battleground');
        var frag = [];
        if(battleground) {
            battleground.empty();
            for (var i = monsters.length - 1; i >= 0; --i) {
                frag.push('' +
                    '<div class="monster" data-monster="' + monsters[i].name + '" data-element="' + monsters[i].el + '">' +
                    '   <div class="monster-img" style="background-position:-' + monsters[i].imgX + 'px -' + monsters[i].imgY + 'px;"></div>' +
                    '   <div class="monster-details">' +
                    '       <span class="name">' + monsters[i].name + '</span>' +
                    '       <div class="healthbar">' +
                    '       <span class="health-digit"><span>' + monsters[i].maxHealth + '</span> ‚ù§Ô∏è</span>' +
                    '           <div class="inner-health"></div>' +
                    '       </div>' +
                    '       <div class="stats clearfix">' +
                    '           <span class="level">LVL: ' + monsters[i].lvl + '</span>' +
                    '           <span class="dmg">dmg: <span>' + monsters[i].dmg + '</span>Ô∏è</span>' +
                    '           <span class="elemental">el: <span>' + monsters[i].el + '</span>Ô∏è</span>' +
                    '           <span class="armor">armor: <span>' + monsters[i].armor + '</span>Ô∏è</span>' +
                    '       </div>' +
                    '   </div>' +
                    '   <button class="attack-monster"><i class="gi gi-crosshair"></i></button>' +
                    '</div>');
            }
            battleground.append(frag.join(''));
            battleground.animate({ scrollTop: battleground[0].scrollHeight}, 1000);
        }
    }
    /**
     * Render the inventory with items owned
     * @param inventory
     */
    function renderInventory(inventory){
        console.log('renderInventory()');
        // Update Healthbar
        var holder = $('#inventory');
        var frag = [];
        if(holder) {
            holder.empty();
            frag.push('<div id="item-viewer" class="clearfix"></div>');
            frag.push('<div class="inventory-grid clearfix">');
            for (i=0;i < inventory.length; i++) {
                frag.push('' +
                    '<div class="item" data-item="' + inventory[i].name + '" data-item-id="' + inventory[i].id + '">' +
                    '   <div class="item-img" style="background-image:url(' + inventory[i].imgURL + ');"></div>' +
                    '</div>');
            }
            frag.push('</div>');
            holder.append(frag.join(''));
            renderWeaponViewer();
        }
    }
    /**
     * Render the inventory Viewer
     * @param item
     */
    function renderWeaponViewer(weapon){
        console.log('renderWeaponViewer()');
        var holder = $('#item-viewer');
        var frag = [];
        if(!weapon || weapon == '') {
            var weapon = state.player.weapon;
        }
        if(holder) {
            holder.empty();
            holder.css('background-image', 'url(' + weapon.imgURL + ')');
            frag.push('' +
                '<div class="stats">' +
                '   <span class="element">el: ' + weapon.el + '</span>' +
                '   <span class="dmg">dmg: ' + weapon.dmg + '</span>' +
                '   <span class="crit">crit: ' + weapon.crit + '</span>' +
                '   <span class="special">sp: ' + weapon.special + '</span>' +
                '</div>' +
                '<div class="actions">' +
                '   <button class="equip" data-item-id="'+ weapon.id +'">Equip</button><br>' +
                '   <button class="delete" data-item-id="'+ weapon.id +'" data-button="red"><i class="gi gi-trash-can"></i></button>' +
                '</div>');
            holder.append(frag.join(''));

            $('.inventory-grid .item').removeClass('active');
            var selectedItem = $('.inventory-grid .item[data-item-id="'+ weapon.id +'"]');
            if(!selectedItem.hasClass('active')){
                selectedItem.addClass('active');
            }
        }
    }
    /**
     * Generate Weapon
     * @param player
     */
    function generateWeapon(player){
        console.log('generateWeapon()');
        var weapon_number = state.inventory.length + 1;
        var weaponID = 'w' + weapon_number.toString();
        var weapon_dmg = randomIntFromInterval(player.lvl*1.5+25,player.lvl*2+50);
        var weapon_crit = randomIntFromInterval(weapon_dmg * 1.25,weapon_dmg * 1.75);
        var weapon_img = 'img/Sword'+ randomIntFromInterval(1,23) +'.png';
        var weapon = {
            id: weaponID,
            name: randomMonsterName(),
            dmg: weapon_dmg,
            el: randomElemental(),
            crit: weapon_crit,
            special: weapon_dmg + weapon_crit,
            imgURL: weapon_img
        };
        return weapon;
    }
    /**
     * Get Weapon
     * @param itemID
     */
    function getWeapon(weaponID){
        for(i=0;i<state.inventory.length;i++){
            if(state.inventory[i].id === weaponID){
                return state.inventory[i];
            }
        }
    }
    /**
     * Toggle Inventory
     */
    function toggleInventory(){
        var inventory = $('#inventory');
        if(inventory.hasClass('active')){
            inventory.removeClass('active');
        } else {
            inventory.addClass('active');
        }
    }
    /**
     * Actions / Buttons
     */
    // Player Attack
    $(document).on('click', '.player-attack', function() {
        console.log(state.monsters);
        var player = state.player;
        var monsterID = $('#battleground > .monster:last-of-type').data('monster');
        var monster = getMonster(monsterID);
        //var battleground = $('#battleground');
        //battleground.animate({ scrollTop: battleground[0].scrollHeight}, 1000);
        attack(player, monster);
    });
    // Player Potion
    $(document).on('click', '.player-potion', function() {
        var player = state.player;
        player.health = player.health+50;
        if(player.health > player.maxHealth){
            player.health = player.maxHealth;
        }
        updatePlayer(player);
    });
    // Game Reset
    $(document).on('click', '#game-reset', function() {
        gameReset();
    });
    // Attack Monster
    $('#battleground').on('click', '.attack-monster', function() {
        var current_monster = $(this).closest('.monster');
        var player = state.player;
        var monsterID = current_monster.data('monster');
        var monster = getMonster(monsterID);
        console.log(player);
        attack(player, monster);
    });
    // Open Inventory
    $(document).on('click', '.toggle-inventory', function() {
        toggleInventory();
    });
    // Open item in viewer
    $('#inventory').on('click', '.item', function() {
        var weaponID = $(this).data('item-id');
        var weapon = getWeapon(weaponID);
        var viewer = $('#item-viewer');
        renderWeaponViewer(weapon);
    });
    // Set Item from inventory
    $(document).on('click', '#item-viewer button.equip', function() {
        var weaponID = $(this).data('item-id');
        var weapon = getWeapon(weaponID);
        state.player.weapon = weapon;
        updatePlayerWeapon(state.player);
    });
    // Delete Item from inventory
    $(document).on('click', '#item-viewer button.delete', function() {
        var weaponID = $(this).data('item-id');
        var weapon = getWeapon(weaponID);
        var deleteConfirm = confirm("Are you SURE you want to delete this item?");
        if (deleteConfirm == true) {
            deleteInventoryItem(weapon.id);
        }
    });



}); // document.ready
</script>
</body>
</html>
